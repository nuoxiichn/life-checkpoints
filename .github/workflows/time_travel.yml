name: Time Capsule Delivery

on:
  schedule:
    - cron: '59 15 31 12 *'
  workflow_dispatch:

jobs:
  decrypt_and_email:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check and Decrypt
        id: decrypt
        env:
          KEY: ${{ secrets.TIME_CAPSULE_KEY }}
        run: |
          CURRENT_YEAR=$(date +'%Y')
          TARGET_YEAR=$((CURRENT_YEAR - 9))
          FILE_PATH="${TARGET_YEAR}/letter_to_future.enc"
          
          echo "Checking for letter from ${TARGET_YEAR}..."
          
          if [ -f "$FILE_PATH" ]; then
            echo "Found encrypted letter at ${FILE_PATH}. Decrypting..."
            
            openssl enc -d -aes-256-cbc -pbkdf2 -in "$FILE_PATH" -out output.md -k "$KEY"
            
            if [ $? -eq 0 ]; then
              echo "âœ… Decryption successful."
              echo "status=found" >> $GITHUB_OUTPUT
              echo "target_year=${TARGET_YEAR}" >> $GITHUB_OUTPUT
            else
              echo "âŒ Decryption failed. Check your password."
              exit 1
            fi
          else
            echo "No letter found for ${TARGET_YEAR}."
            echo "status=skipped" >> $GITHUB_OUTPUT
          fi

      - name: Convert Markdown to HTML
        if: steps.decrypt.outputs.status == 'found'
        run: |
          pip install markdown
          python -c "
          import markdown
          with open('output.md', 'r', encoding='utf-8') as f:
              text = f.read()
          html_content = markdown.markdown(text)
          styled_html = f'''
          <div style='font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #37352f; max-width: 800px;'>
              {html_content}
              <hr style='border: 0; border-top: 1px solid #eaecef; margin: 20px 0;'>
              <p style='font-size: 12px; color: #999;'>Sent from your <b>Life Checkpoints</b> repository.</p>
          </div>
          '''
          with open('email_body.html', 'w', encoding='utf-8') as f:
              f.write(styled_html)
          "

      - name: Email the Letter
        if: steps.decrypt.outputs.status == 'found'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ðŸ“¬ Time Capsule Opened: Letter from ${{ steps.decrypt.outputs.target_year }}"
          
          html_body: file://email_body.html
          
          to: ${{ secrets.MAIL_USERNAME }}
          from: "Life Checkpoints <${{ secrets.MAIL_USERNAME }}>"
          secure: true

      - name: Secure Cleanup
        if: always()
        run: |
          rm -f output.md email_body.html